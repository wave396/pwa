<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Logic Detective TWA</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/framework7@8.3.3/framework7-bundle.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Playfair+Display:ital@1&family=Courier+Prime&display=swap" rel="stylesheet">
  
  <style>
    :root { --f7-theme-color: #2196f3; }
    
    /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –≤ –¥—É—Ö–µ Material Design 3 */
    .message-text { 
        font-family: 'Roboto', sans-serif; 
        box-shadow: var(--f7-card-shadow); 
        border-radius: 12px !important; 
    }
    
    /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –ù—É–∞—Ä–∞ */
    .theme-jake .message-received .message-text {
        background: #263238; color: #eceff1; font-family: 'Courier Prime', monospace;
    }
    
    /* –°–≤–µ—Ç–ª–∞—è/–í–∏–Ω—Ç–∞–∂–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –ê–Ω—Ä–∏ */
    .theme-henri .message-received .message-text {
        background: #efebe9; color: #3e2723; font-family: 'Playfair Display', serif;
    }

    .message-sent .message-text { background: var(--f7-theme-color); color: #fff; }

    #typing-status { font-size: 12px; margin-left: 20px; font-style: italic; display: none; }
    
    .logo-area { padding: 40px 20px; text-align: center; background: var(--f7-theme-color); color: #fff; }
  </style>
</head>
<body class="theme-dark"> <div id="app">
    <div class="panel panel-left panel-cover">
      <div class="page">
        <div class="logo-area">
          <h2 style="margin:0">Detective</h2>
          <p style="opacity:0.8">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–µ–ª–∞</p>
        </div>
        <div class="page-content">
          <div class="list no-hairlines">
            <ul>
              <li>
                <div class="item-content">
                  <div class="item-inner">
                    <div class="item-title">–ù–æ—á–Ω–æ–π —Ä–µ–∂–∏–º</div>
                    <div class="item-after">
                      <label class="toggle toggle-init">
                        <input type="checkbox" id="theme-switch" checked onchange="toggleTheme()">
                        <span class="toggle-icon"></span>
                      </label>
                    </div>
                  </div>
                </div>
              </li>
            </ul>
          </div>
          
          <div class="block-title">–ü–µ—Ä—Å–æ–Ω–∞–∂</div>
          <div class="list">
            <ul>
              <li><label class="item-radio item-content"><input type="radio" name="char" value="Jake" checked onclick="setChar('Jake')"/><i class="icon icon-radio"></i><div class="item-inner"><div class="item-title">–î–∂–µ–π–∫ (–ù—É–∞—Ä)</div></div></label></li>
              <li><label class="item-radio item-content"><input type="radio" name="char" value="Henri" onclick="setChar('Henri')"/><i class="icon icon-radio"></i><div class="item-inner"><div class="item-title">–ê–Ω—Ä–∏ (–í–∏–Ω—Ç–∞–∂)</div></div></label></li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="view view-main">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="left"><a href="#" class="panel-open link icon-only" data-panel="left">‚ò∞</a></div>
            <div class="title" id="nav-title">–î–∂–µ–π–∫ –¢—Ä–µ–Ω—Ç</div>
          </div>
        </div>

        <div class="toolbar messagebar toolbar-bottom">
          <div class="toolbar-inner">
            <div class="messagebar-area">
              <textarea id="msg-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
            </div>
            <a href="#" class="link icon-only" onclick="handleSend()">üöÄ</a>
          </div>
        </div>

        <div class="page-content messages-content" id="chat-container">
          <div id="typing-status">–î–µ—Ç–µ–∫—Ç–∏–≤ —Ä–∞–∑–º—ã—à–ª—è–µ—Ç...</div>
          <div class="messages" id="chat-box"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/framework7@8.3.3/framework7-bundle.min.js"></script>
  <script>
    const app = new Framework7({ root: '#app', theme: 'md' });
    let state = { char: 'Jake', lv: 1 };
    
    let chatHistories = {
      Jake: [{ text: "–°–ª—É—à–∞—é, –ø—Ä–∏—è—Ç–µ–ª—å. –û –∫–∞–∫–æ–º –¥–µ–ª–µ –ø–æ–π–¥–µ—Ç —Ä–µ—á—å?", type: 'welcome' }],
      Henri: [{ text: "–ú–æ–π –¥—Ä—É–≥, —è –≥–æ—Ç–æ–≤ –≤—ã—Å–ª—É—à–∞—Ç—å –≤–∞—à—É –∏—Å—Ç–æ—Ä–∏—é. –ù–∞—á–Ω–µ–º?", type: 'welcome' }]
    };

    function toggleTheme() {
        const isDark = document.getElementById('theme-switch').checked;
        if(isDark) document.getElementById('app').classList.add('theme-dark');
        else document.getElementById('app').classList.remove('theme-dark');
    }

    function setChar(id) {
        state.char = id;
        document.getElementById('nav-title').innerText = id === 'Jake' ? '–î–∂–µ–π–∫ –¢—Ä–µ–Ω—Ç' : '–ê–Ω—Ä–∏ –î–µ–ª–∞–∫—Ä—É–∞';
        const container = document.getElementById('chat-container');
        container.className = 'page-content messages-content theme-' + id.toLowerCase();
        renderHistory();
    }

    function renderHistory() {
        const box = document.getElementById('chat-box');
        box.innerHTML = '';
        chatHistories[state.char].forEach(m => draw(m.text, m.type === 'welcome' ? 'received' : m.type, false));
    }

    function draw(text, type, anim = true) {
        const box = document.getElementById('chat-box');
        const msgHtml = `<div class="message message-${type}"><div class="message-content"><div class="message-text"></div></div></div>`;
        box.insertAdjacentHTML('beforeend', msgHtml);
        const target = box.lastChild.querySelector('.message-text');
        
        if(type === 'received' && anim) {
            let i = 0;
            function typeWriter() {
                if (i < text.length) { target.textContent += text.charAt(i); i++; setTimeout(typeWriter, 15); }
            }
            typeWriter();
        } else { target.textContent = text; }
        
        document.querySelector('.messages-content').scrollTop = 100000;
    }

    async function handleSend() {
        const inp = document.getElementById('msg-input');
        const text = inp.value.trim();
        if(!text) return;

        chatHistories[state.char].push({ text, type: 'sent' });
        draw(text, 'sent', false);
        inp.value = '';

        document.getElementById('typing-status').style.display = 'block';

        try {
            const hist = chatHistories[state.char].filter(m => m.type !== 'welcome');
            const res = await fetch('https://logic-q6qn.onrender.com/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ char_id: state.char + state.lv, history: hist })
            });
            const data = await res.json();
            document.getElementById('typing-status').style.display = 'none';
            chatHistories[state.char].push({ text: data.reply, type: 'received' });
            draw(data.reply, 'received', true);
        } catch(e) {
            document.getElementById('typing-status').style.display = 'none';
            draw("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö...", 'received');
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    setChar('Jake');
  </script>
</body>
</html>

