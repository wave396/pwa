<!DOCTYPE html>
<html class="md">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Интеллектуальные расследования</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/framework7@8/framework7-bundle.min.css">
  <style>
    :root { --f7-theme-color: #37474f; }
    html, body, #app { height: 100%; width: 100%; margin: 0; background: #1a1a1a; color: #eee; }
    
    /* Стили для стартового экрана */
    .welcome-screen {
      background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1453722758971-da80396495ac?q=80&w=1000&auto=format&fit=crop');
      background-size: cover; background-position: center;
      padding: 40px 20px; text-align: center; height: 100%; overflow-y: auto;
    }
    .welcome-title { font-size: 28px; font-weight: bold; margin-bottom: 20px; color: #fff; text-transform: uppercase; letter-spacing: 2px; }
    .welcome-text { font-family: 'Georgia', serif; line-height: 1.6; font-style: italic; margin-bottom: 30px; color: #ccc; }
    .character-card { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 15px; margin-bottom: 15px; text-align: left; border-left: 4px solid #546e7a; }
    .char-name { font-weight: bold; color: #fff; margin-bottom: 5px; }
    .char-desc { font-size: 13px; opacity: 0.8; }
    
    /* Чат */
    .message-text { font-family: 'Courier New', Courier, monospace; font-size: 15px; }
    .framework7-initialized #emergency-msg { display: none !important; }
  </style>
</head>
<body>

  <div id="app">
    <div class="view view-main view-init">
      
      <div class="page" id="welcome-page">
        <div class="page-content welcome-screen">
          <div class="welcome-title">Интеллектуальные расследования</div>
          
          <div class="welcome-text">
            Это не игра на скорость. И не тест на эрудицию. <br>
            Здесь нет насилия, стрельбы и случайных побед. <br>
            Каждое дело — это диалог, наблюдение и вывод.
          </div>

          <div style="text-align:left; margin-bottom:10px; font-size:12px; opacity:0.5;">ПЕРСОНАЖИ</div>
          
          <div class="character-card">
            <div class="char-name">Джейк Трент</div>
            <div class="char-desc">Городской нуар. Дождь, тени, дым. Говорит прямо. Думает мрачно.</div>
          </div>

          <div class="character-card">
            <div class="char-name">Анри Делакруа</div>
            <div class="char-desc">Французский следователь. Ироничен и философичен. Замечает детали.</div>
          </div>

          <div class="welcome-text" style="font-size: 14px; margin-top:20px;">
            Ты читаешь. Ты задаёшь вопросы. <br>
            Здесь нет правильных ответов — есть логичные.
          </div>

          <button class="button button-fill button-large color-white text-color-black" onclick="startApp()">Начать расследование</button>
          <div style="height:50px;"></div>
        </div>
      </div>

      <div class="page stacked" id="main-game-page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="left"><a href="#" class="link icon-only panel-open" data-panel="left">☰</a></div>
            <div class="title" id="det-name">Джейк Трент</div>
            <div class="right"><span id="diff-label" class="badge color-gray">LVL 1</span></div>
          </div>
        </div>

        <div class="toolbar messagebar toolbar-bottom">
          <div class="toolbar-inner">
            <div class="messagebar-area">
              <textarea id="msg-input" placeholder="Введите название дела или ваш ход..."></textarea>
            </div>
            <a href="#" class="link" onclick="handleSend()">Отправить</a>
          </div>
        </div>

        <div class="page-content messages-content" style="background: #121212;">
          <div class="messages" id="chat-box">
            <div class="message message-received">
              <div class="message-content">
                <div class="message-text">Я слушаю, приятель. Какое дело у нас на повестке? Назови его, и начнем.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <div class="panel panel-left panel-cover theme-dark">
      <div class="page">
        <div class="page-content">
          <div class="block-title">Выбор Детектива</div>
          <div class="list no-hairlines">
            <ul>
              <li>
                <label class="item-radio item-content">
                  <input type="radio" name="char" value="Jake" checked onclick="updateChar('Jake', 'Джейк Трент')"/>
                  <i class="icon icon-radio"></i>
                  <div class="item-inner"><div class="item-title">Джейк Трент</div></div>
                </label>
              </li>
              <li>
                <label class="item-radio item-content">
                  <input type="radio" name="char" value="Henri" onclick="updateChar('Henri', 'Анри Делакруа')"/>
                  <i class="icon icon-radio"></i>
                  <div class="item-inner"><div class="item-title">Анри Делакруа</div></div>
                </label>
              </li>
            </ul>
          </div>
          
          <div class="block-title">Сложность</div>
          <div class="list no-hairlines">
            <ul>
              <li><label class="item-radio item-content"><input type="radio" name="lv" value="1" checked onclick="updateLv(1)"/><i class="icon icon-radio"></i><div class="item-inner"><div class="item-title">Уровень 1</div></div></label></li>
              <li><label class="item-radio item-content"><input type="radio" name="lv" value="2" onclick="updateLv(2)"/><i class="icon icon-radio"></i><div class="item-inner"><div class="item-title">Уровень 2</div></div></label></li>
              <li><label class="item-radio item-content"><input type="radio" name="lv" value="3" onclick="updateLv(3)"/><i class="icon icon-radio"></i><div class="item-inner"><div class="item-title">Уровень 3</div></div></label></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/framework7@8/framework7-bundle.min.js"></script>
  <script>
    var app = new Framework7({ root: '#app', theme: 'md' });
    var mainView = app.views.main;

    var state = { char: 'Jake', lv: 1 };

    function startApp() {
      // Переход со стартового экрана в игру
      document.getElementById('welcome-page').classList.add('stacked');
      document.getElementById('main-game-page').classList.remove('stacked');
    }

    function updateChar(id, name) { 
        state.char = id; 
        document.getElementById('det-name').innerText = name; 
        // При смене персонажа меняем приветствие
        const greeting = (id === 'Jake') ? "Я слушаю, приятель. Какое дело сегодня?" : "Я весь во внимании, друг. Какую тайну мы затронем?";
        addMessage(greeting, 'received');
    }
    
    function updateLv(n) { 
        state.lv = n; 
        document.getElementById('diff-label').innerText = 'LVL ' + n; 
    }

    function addMessage(text, type) {
      const chat = document.getElementById('chat-box');
      chat.innerHTML += `<div class="message message-${type}"><div class="message-content"><div class="message-text">${text}</div></div></div>`;
      app.views.main.router.scrollToBottom();
    }

    async function handleSend() {
      const inp = document.getElementById('msg-input');
      const text = inp.value.trim();
      if(!text) return;
      
      addMessage(text, 'sent');
      inp.value = '';

      // Формируем ID для сервера, например "Jake1" или "Henri2"
      const characterId = state.char + state.lv;
      
      try {
        const response = await fetch('https://logic-q6qn.onrender.com/api/chat', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ char_id: characterId, message: text })
        });
        const data = await response.json();
        addMessage(data.reply, 'received');
      } catch(e) {
        addMessage("Ошибка связи с сервером. Проверьте Render.", 'received');
      }
    }
  </script>
</body>
</html>

