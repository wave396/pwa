<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Logic Detective</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/framework7@8.3.3/framework7-bundle.min.css">
  
  <style>
    /* Базовый фон, чтобы не было белого экрана при загрузке */
    :root { --f7-theme-color: #2196f3; }
    html, body { background: #121212; color: #ffffff; margin: 0; padding: 0; height: 100%; overflow: hidden; }
    
    #app { background: #121212; }

    /* Стилизация сообщений */
    .message-text { 
        font-size: 16px;
        border-radius: 12px !important; 
        line-height: 1.4;
    }
    
    .theme-jake .message-received .message-text {
        background: #1e272e; color: #dcdde1; border-left: 4px solid #487eb0;
    }
    
    .theme-henri .message-received .message-text {
        background: #2f2f2f; color: #f5f6fa; border-left: 4px solid #e1b12c;
    }

    .message-sent .message-text { background: #2196f3; color: #fff; }

    #typing-status { font-size: 12px; margin-left: 20px; font-style: italic; display: none; color: #aaa; }
    
    .logo-area { padding: 40px 20px; text-align: center; background: #1976d2; color: #fff; }
    
    /* Убираем лишние отступы в Material теме */
    .messages { background: transparent !important; }
  </style>
</head>
<body class="theme-dark">

  <div id="app">
    <div class="panel panel-left panel-cover">
      <div class="page">
        <div class="logo-area">
          <h2 style="margin:0">Detective</h2>
          <p style="opacity:0.8">Настройки дела</p>
        </div>
        <div class="page-content">
          <div class="list no-hairlines">
            <ul>
              <li>
                <div class="item-content">
                  <div class="item-inner">
                    <div class="item-title">Ночной режим</div>
                    <div class="item-after">
                      <label class="toggle toggle-init">
                        <input type="checkbox" id="theme-switch" checked onchange="toggleTheme()">
                        <span class="toggle-icon"></span>
                      </label>
                    </div>
                  </div>
                </div>
              </li>
            </ul>
          </div>
          
          <div class="block-title">Персонаж</div>
          <div class="list">
            <ul>
              <li><label class="item-radio item-content"><input type="radio" name="char" value="Jake" checked onclick="setChar('Jake')"/><i class="icon icon-radio"></i><div class="item-inner"><div class="item-title">Джейк (Нуар)</div></div></label></li>
              <li><label class="item-radio item-content"><input type="radio" name="char" value="Henri" onclick="setChar('Henri')"/><i class="icon icon-radio"></i><div class="item-inner"><div class="item-title">Анри (Винтаж)</div></div></label></li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="view view-main">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="left"><a href="#" class="panel-open link icon-only" data-panel="left">☰</a></div>
            <div class="title" id="nav-title">Джейк Трент</div>
          </div>
        </div>

        <div class="toolbar messagebar toolbar-bottom">
          <div class="toolbar-inner">
            <div class="messagebar-area">
              <textarea id="msg-input" placeholder="Введите сообщение..."></textarea>
            </div>
            <a href="#" class="link" onclick="handleSend()" style="font-weight: bold; padding: 0 10px;">ОТПРАВИТЬ</a>
          </div>
        </div>

        <div class="page-content messages-content" id="chat-container">
          <div id="typing-status">Детектив размышляет...</div>
          <div class="messages" id="chat-box"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/framework7@8.3.3/framework7-bundle.min.js"></script>
  
  <script>
    // Инициализация только после загрузки документа
    document.addEventListener('DOMContentLoaded', function () {
        const app = new Framework7({ 
            root: '#app', 
            theme: 'md',
            touch: { tapHold: true }
        });

        window.f7App = app; // сохраняем ссылку для отладки
        setChar('Jake');
    });

    let state = { char: 'Jake', lv: 1 };
    let chatHistories = {
      Jake: [{ text: "Слушаю, приятель. О каком деле пойдет речь?", type: 'welcome' }],
      Henri: [{ text: "Мой друг, я готов выслушать вашу историю. Начнем?", type: 'welcome' }]
    };

    function toggleTheme() {
        const isDark = document.getElementById('theme-switch').checked;
        const appEl = document.getElementById('app');
        if(isDark) appEl.classList.add('theme-dark');
        else appEl.classList.remove('theme-dark');
    }

    function setChar(id) {
        state.char = id;
        document.getElementById('nav-title').innerText = id === 'Jake' ? 'Джейк Трент' : 'Анри Делакруа';
        const container = document.getElementById('chat-container');
        container.className = 'page-content messages-content theme-' + id.toLowerCase();
        renderHistory();
    }

    function renderHistory() {
        const box = document.getElementById('chat-box');
        box.innerHTML = '';
        chatHistories[state.char].forEach(m => draw(m.text, m.type === 'welcome' ? 'received' : m.type, false));
    }

    function draw(text, type, anim = true) {
        const box = document.getElementById('chat-box');
        const msgHtml = '<div class="message message-' + type + '"><div class="message-content"><div class="message-text"></div></div></div>';
        box.insertAdjacentHTML('beforeend', msgHtml);
        const target = box.lastElementChild.querySelector('.message-text');
        
        if(type === 'received' && anim) {
            let i = 0;
            function typeWriter() {
                if (i < text.length) { 
                    target.textContent += text.charAt(i); 
                    i++; 
                    setTimeout(typeWriter, 15); 
                }
            }
            typeWriter();
        } else { 
            target.textContent = text; 
        }
        
        // Прокрутка
        const container = document.querySelector('.messages-content');
        container.scrollTop = container.scrollHeight;
    }

    async function handleSend() {
        const inp = document.getElementById('msg-input');
        const text = inp.value.trim();
        if(!text) return;

        chatHistories[state.char].push({ text: text, type: 'sent' });
        draw(text, 'sent', false);
        inp.value = '';

        document.getElementById('typing-status').style.display = 'block';

        try {
            const hist = chatHistories[state.char].filter(m => m.type !== 'welcome');
            const res = await fetch('https://logic-q6qn.onrender.com/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ char_id: state.char + state.lv, history: hist })
            });
            const data = await res.json();
            document.getElementById('typing-status').style.display = 'none';
            
            const reply = data.reply || "Детектив молчит...";
            chatHistories[state.char].push({ text: reply, type: 'received' });
            draw(reply, 'received', true);
        } catch(e) {
            document.getElementById('typing-status').style.display = 'none';
            draw("Ошибка связи с базой данных. Проверьте интернет.", 'received');
        }
    }
  </script>
</body>
</html>

