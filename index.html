<!DOCTYPE html>
<html class="md">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Интеллектуальные расследования</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/framework7@8/framework7-bundle.min.css">
  <style>
    :root { --f7-theme-color: #546e7a; }
    html, body, #app { height: 100%; width: 100%; margin: 0; background: #000; color: #eee; }
    .page { background: #121212; }
    .welcome-screen {
      background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1453722758971-da80396495ac?q=80&w=1000&auto=format&fit=crop');
      background-size: cover; background-position: center;
      padding: 40px 24px; text-align: center; height: 100%; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center;
    }
    .welcome-title { font-size: 26px; font-weight: 800; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 3px; color: #fff; }
    .welcome-text { font-family: 'Georgia', serif; line-height: 1.5; font-style: italic; color: #bbb; margin-bottom: 20px; }
    .char-preview { background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; margin-bottom: 10px; text-align: left; border-left: 3px solid #fff; }
    .char-preview b { display: block; color: #fff; margin-bottom: 4px; }
    .char-preview span { font-size: 13px; opacity: 0.7; }
    .messages-content { background: #0a0a0a !important; }
    .message-text { font-family: 'Courier New', Courier, monospace; font-size: 15px; line-height: 1.4; white-space: pre-wrap; }
    .msg-jake .message-text { color: #d1d1d1; }
    .msg-henri .message-text { color: #e0f2f1; border-left: 2px solid #4db6ac; padding-left: 8px; }
    #main-game-page { display: none; }
    .game-active #welcome-page { display: none; }
    .game-active #main-game-page { display: block; }
    .item-title { color: #fff !important; font-size: 16px !important; }
  </style>
</head>
<body>

  <div id="app">
    <div class="view view-main">
      <div class="page" id="welcome-page">
        <div class="page-content welcome-screen">
          <div class="welcome-title">Расследования</div>
          <div class="welcome-text">Диалог, наблюдение и вывод. Здесь нет правильных ответов — есть логичные.</div>
          <div class="char-preview"><b>Джейк Трент</b><span>Нуар. Дождь, тени и факты.</span></div>
          <div class="char-preview"><b>Анри Делакруа</b><span>Ирония и детали.</span></div>
          <button class="button button-fill button-large color-white text-color-black" onclick="startApp()" style="margin-top:20px; font-weight:bold;">Начать игру</button>
        </div>
      </div>

      <div class="page" id="main-game-page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="left"><a href="#" class="link icon-only panel-open" data-panel="left">☰</a></div>
            <div class="title" id="det-name">Джейк Трент</div>
            <div class="right"><span id="diff-label" class="badge color-blue">LVL 1</span></div>
          </div>
        </div>

        <div class="toolbar messagebar toolbar-bottom">
          <div class="toolbar-inner">
            <div class="messagebar-area">
              <textarea id="msg-input" placeholder="Введите название дела..."></textarea>
            </div>
            <a href="#" class="link" onclick="handleSend()">Отправить</a>
          </div>
        </div>

        <div class="page-content messages-content">
          <div class="messages" id="chat-box"></div>
        </div>
      </div>
    </div>

    <div class="panel panel-left panel-cover theme-dark">
      <div class="page">
        <div class="page-content">
          <div class="block-title">Выберите детектива</div>
          <div class="list">
            <ul>
              <li>
                <label class="item-radio item-content">
                  <input type="radio" name="char" value="Jake" checked onclick="switchCharacter('Jake', 'Джейк Трент')"/>
                  <i class="icon icon-radio"></i>
                  <div class="item-inner"><div class="item-title">Джейк Трент</div></div>
                </label>
              </li>
              <li>
                <label class="item-radio item-content">
                  <input type="radio" name="char" value="Henri" onclick="switchCharacter('Henri', 'Анри Делакруа')"/>
                  <i class="icon icon-radio"></i>
                  <div class="item-inner"><div class="item-title">Анри Делакруа</div></div>
                </label>
              </li>
            </ul>
          </div>
          <div class="block-title">Сложность</div>
          <div class="list">
            <ul>
              <li><label class="item-radio item-content"><input type="radio" name="lv" value="1" checked onclick="updateLv(1)"/><i class="icon icon-radio"></i><div class="item-inner"><div class="item-title">Уровень 1</div></div></label></li>
              <li><label class="item-radio item-content"><input type="radio" name="lv" value="2" onclick="updateLv(2)"/><i class="icon icon-radio"></i><div class="item-inner"><div class="item-title">Уровень 2</div></div></label></li>
              <li><label class="item-radio item-content"><input type="radio" name="lv" value="3" onclick="updateLv(3)"/><i class="icon icon-radio"></i><div class="item-inner"><div class="item-title">Уровень 3</div></div></label></li>
            </ul>
          </div>
          <div class="block"><button class="button button-fill panel-close">Принять</button></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/framework7@8/framework7-bundle.min.js"></script>
  <script>
    var app = new Framework7({ root: '#app', theme: 'md' });
    var state = { char: 'Jake', lv: 1 };
    
    // Приветственные сообщения теперь помечены как 'welcome'
    var chatHistories = {
      Jake: [{ text: "Я слушаю, приятель. Какое дело у нас на повестке?", type: 'welcome' }],
      Henri: [{ text: "Я весь во внимании, мой друг. Какую тайну мы затронем сегодня?", type: 'welcome' }]
    };

    function startApp() {
      document.getElementById('app').classList.add('game-active');
      renderCurrentHistory();
    }

    function switchCharacter(id, name) {
      state.char = id;
      document.getElementById('det-name').innerText = name;
      renderCurrentHistory();
    }

    function updateLv(n) {
      state.lv = n;
      document.getElementById('diff-label').innerText = 'LVL ' + n;
    }

    function renderCurrentHistory() {
      const chatContainer = document.getElementById('chat-box');
      chatContainer.innerHTML = "";
      const history = chatHistories[state.char];
      history.forEach(msg => {
        // Отрисовываем 'welcome' как 'received' (от детектива)
        drawMessage(msg.text, msg.type === 'welcome' ? 'received' : msg.type);
      });
    }

    function drawMessage(text, type) {
      const chat = document.getElementById('chat-box');
      const charClass = (state.char === 'Jake') ? 'msg-jake' : 'msg-henri';
      const msgHtml = `<div class="message message-${type} ${type==='received'?charClass:''}"><div class="message-content"><div class="message-text">${text}</div></div></div>`;
      chat.insertAdjacentHTML('beforeend', msgHtml);
      setTimeout(() => { 
        const container = document.querySelector('.messages-content');
        if(container) container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
      }, 100);
    }

    async function handleSend() {
      const inp = document.getElementById('msg-input');
      const text = inp.value.trim();
      if(!text) return;
      
      chatHistories[state.char].push({ text: text, type: 'sent' });
      drawMessage(text, 'sent');
      inp.value = '';

      const characterId = state.char + state.lv;

      // ОЧИСТКА ИСТОРИИ: Убираем приветственное сообщение перед отправкой в Gemini
      const cleanHistory = chatHistories[state.char].filter(m => m.type !== 'welcome');

      try {
        const response = await fetch('https://logic-q6qn.onrender.com/api/chat', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ 
            char_id: characterId,
            history: cleanHistory 
          })
        });
        
        const data = await response.json();
        const reply = data.reply || "Детектив молчит...";
        
        chatHistories[state.char].push({ text: reply, type: 'received' });
        drawMessage(reply, 'received');
        
      } catch(e) {
        drawMessage("Ошибка связи. Попробуйте снова.", 'received');
      }
    }
  </script>
</body>
</html>

