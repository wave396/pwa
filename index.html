<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <title>Logic Detective PWA</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/framework7/1.4.2/css/framework7.material.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/framework7/1.4.2/css/framework7.material.colors.min.css">
    
    <style>
        /* Кастомные правки для атмосферы */
        .message { margin-bottom: 15px; }
        .message-text { padding: 10px 15px; border-radius: 8px; font-size: 15px; line-height: 1.4; display: inline-block; max-width: 85%; }
        
        /* Стили для Джейка (Нуар) */
        .theme-jake .message-received .message-text { background: #cfd8dc; color: #263238; border-left: 4px solid #455a64; font-family: monospace; }
        
        /* Стили для Анри (Винтаж) */
        .theme-henri .message-received .message-text { background: #d7ccc8; color: #3e2723; border-left: 4px solid #8d6e63; font-family: serif; }
        
        .message-sent { text-align: right; }
        .message-sent .message-text { background: #2196f3; color: #fff; text-align: left; }
        
        #typing-notice { padding: 5px 20px; font-size: 12px; font-style: italic; opacity: 0.6; display: none; }
        .panel { background: #f5f5f5; }
        .theme-dark { background: #212121 !important; color: #fff; }
    </style>
</head>
<body class="layout-dark"> <div class="panel-overlay"></div>

    <div class="panel panel-left panel-cover">
        <div class="content-block-title">Настройки</div>
        <div class="list-block">
            <ul>
                <li>
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-title">Джейк Трент</div>
                            <div class="item-after">
                                <label class="label-radio">
                                    <input type="radio" name="char-radio" value="Jake" checked="checked" onchange="switchChar('Jake')">
                                    <div class="item-media"><i class="icon icon-form-radio"></i></div>
                                </label>
                            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-title">Анри Делакруа</div>
                            <div class="item-after">
                                <label class="label-radio">
                                    <input type="radio" name="char-radio" value="Henri" onchange="switchChar('Henri')">
                                    <div class="item-media"><i class="icon icon-form-radio"></i></div>
                                </label>
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
        <div class="content-block">
            <p><a href="#" class="button close-panel">Готово</a></p>
        </div>
    </div>

    <div class="views">
        <div class="view view-main">
            <div class="pages navbar-fixed toolbar-fixed">
                <div data-page="index" class="page">
                    
                    <div class="navbar">
                        <div class="navbar-inner">
                            <div class="left"><a href="#" class="open-panel link icon-only">☰</a></div>
                            <div class="center" id="main-title">Джейк Трент</div>
                            <div class="right"></div>
                        </div>
                    </div>

                    <div class="page-content" id="chat-scroller">
                        <div class="content-block" id="chat-box">
                            </div>
                        <div id="typing-notice">Детектив пишет...</div>
                    </div>

                    <div class="toolbar messagebar">
                        <div class="toolbar-inner">
                            <textarea id="msg-input" placeholder="Ваше сообщение..."></textarea>
                            <a href="#" class="link" onclick="handleSend()">ОТПРАВИТЬ</a>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/framework7/1.4.2/js/framework7.min.js"></script>
    
    <script>
        var myApp = new Framework7({
            material: true // Включаем Material Design режим
        });

        var state = { char: 'Jake', lv: 1 };
        var chatHistories = {
            Jake: [{ text: "Слушаю, приятель. О чем пойдет речь?", type: 'received' }],
            Henri: [{ text: "Мой друг, я готов выслушать вашу историю. Начнем?", type: 'received' }]
        };

        // Смена персонажа
        function switchChar(id) {
            state.char = id;
            document.getElementById('main-title').innerText = (id === 'Jake' ? 'Джейк Трент' : 'Анри Делакруа');
            renderHistory();
        }

        // Отрисовка истории
        function renderHistory() {
            var box = document.getElementById('chat-box');
            box.innerHTML = '';
            var hist = chatHistories[state.char];
            for (var i = 0; i < hist.length; i++) {
                draw(hist[i].text, hist[i].type);
            }
        }

        // Функция отрисовки сообщения
        function draw(text, type) {
            var box = document.getElementById('chat-box');
            var charClass = (state.char === 'Jake') ? 'theme-jake' : 'theme-henri';
            var html = '<div class="message message-' + type + ' ' + charClass + '">' +
                       '<div class="message-text">' + text + '</div>' +
                       '</div>';
            box.insertAdjacentHTML('beforeend', html);
            
            // Скролл вниз
            var scroller = document.getElementById('chat-scroller');
            scroller.scrollTop = scroller.scrollHeight;
        }

        // Отправка данных на Render
        async function handleSend() {
            var input = document.getElementById('msg-input');
            var text = input.value.trim();
            if (!text) return;

            // 1. Показываем сообщение пользователя
            chatHistories[state.char].push({ text: text, type: 'sent' });
            draw(text, 'sent');
            input.value = '';

            // 2. Индикатор загрузки
            document.getElementById('typing-notice').style.display = 'block';

            try {
                // Подготовка истории для API (убираем системные пометки)
                var cleanHistory = chatHistories[state.char].slice(-10); 
                
                var response = await fetch('https://logic-q6qn.onrender.com/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        char_id: state.char + state.lv,
                        history: cleanHistory
                    })
                });

                var data = await response.json();
                document.getElementById('typing-notice').style.display = 'none';

                if (data.reply) {
                    chatHistories[state.char].push({ text: data.reply, type: 'received' });
                    draw(data.reply, 'received');
                }
            } catch (e) {
                document.getElementById('typing-notice').style.display = 'none';
                draw("Ошибка связи с детективом. Проверьте сервер.", 'received');
            }
        }

        // Первичная отрисовка
        renderHistory();
    </script>
</body>
</html>

