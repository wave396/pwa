<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui" />
    <title>Logic Detective</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/framework7/1.4.2/css/framework7.material.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/framework7/1.4.2/css/framework7.material.colors.min.css">
    
    <style>
        /* Общие стили сообщений */
        .message { margin-bottom: 14px; clear: both; display: block; width: 100%; }
        .message-text { 
            padding: 12px 16px; 
            border-radius: 20px; 
            font-size: 15px; 
            line-height: 1.5; 
            display: inline-block; 
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Сообщения БОТА: Широкие и с контуром */
        .message-received { float: left; text-align: left; }
        .message-received .message-text { 
            max-width: 98%; 
            background: #ffffff; 
            color: #333; 
            border: 1px solid #b0bec5; /* Контур для светлой темы */
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Сообщения ПОЛЬЗОВАТЕЛЯ */
        .message-sent { float: right; text-align: right; }
        .message-sent .message-text { 
            max-width: 85%; 
            background: #2196f3; 
            color: #fff; 
            border-bottom-right-radius: 4px;
            border: none;
        }

        /* ТЕМЫ ПЕРСОНАЖЕЙ (Шрифты) */
        .theme-jake .message-received .message-text { font-family: monospace; }
        .theme-henri .message-received .message-text { font-family: serif; font-size: 16px; }

        /* НОЧНОЙ РЕЖИМ */
        body.layout-dark .message-received .message-text { 
            background: #263238; 
            color: #eceff1; 
            border-color: #455a64; 
        }
        body.layout-dark .page, body.layout-dark .page-content { background: #121212; }

        /* ИНДИКАТОР LVL В ШАПКЕ */
        #lv-display {
            font-weight: 700;
            font-size: 13px;
            border: 1px solid #2196f3;
            padding: 2px 8px;
            border-radius: 6px;
            background: rgba(33, 150, 243, 0.1);
        }

        /* ПОЛЕ ВВОДА И СТРЕЛКА */
        .toolbar-inner { padding: 0 8px !important; }
        .messagebar textarea {
            font-size: 16px;
            border-radius: 8px;
            background: rgba(0,0,0,0.05);
        }
        body.layout-dark .messagebar textarea { background: rgba(255,255,255,0.1); color: #fff; }
        
        .send-icon {
            font-size: 32px;
            color: #2196f3;
            transform: rotate(-15deg);
            display: inline-block;
            margin-left: 5px;
            line-height: 1;
        }
    </style>
</head>
<body class="layout-dark">

    <div class="panel-overlay"></div>
    <div class="panel panel-left panel-cover">
        <div style="padding: 20px; background: #2196f3; color: #fff;"><h3>Настройки</h3></div>
        <div class="list-block">
            <ul>
                <li><div class="item-content"><div class="item-inner">
                    <div class="item-title">Ночной режим</div>
                    <div class="item-after"><label class="label-switch"><input type="checkbox" id="dark-toggle" checked onchange="toggleNight()"><div class="checkbox"></div></label></div>
                </div></div></li>
            </ul>
        </div>
        <div class="content-block-title">Персонаж и Сложность</div>
        <div class="list-block">
            <ul>
                <li><label class="label-radio item-content"><input type="radio" name="char" value="Jake" checked onchange="switchChar('Jake')"><div class="item-inner"><div class="item-title">Джейк (Нуар)</div></div></label></li>
                <li><label class="label-radio item-content"><input type="radio" name="char" value="Henri" onchange="switchChar('Henri')"><div class="item-inner"><div class="item-title">Анри (Винтаж)</div></div></label></li>
            </ul>
            <ul style="margin-top:10px">
                <li><label class="label-radio item-content"><input type="radio" name="lv" value="1" checked onchange="setLv(1)"><div class="item-inner"><div class="item-title">LV 1 - Стандарт</div></div></label></li>
                <li><label class="label-radio item-content"><input type="radio" name="lv" value="2" onchange="setLv(2)"><div class="item-inner"><div class="item-title">LV 2 - Нуар</div></div></label></li>
                <li><label class="label-radio item-content"><input type="radio" name="lv" value="3" onchange="setLv(3)"><div class="item-inner"><div class="item-title">LV 3 - Мастер</div></div></label></li>
            </ul>
        </div>
    </div>

    <div class="views">
        <div class="view view-main">
            <div class="pages navbar-fixed toolbar-fixed">
                <div class="page">
                    <div class="navbar">
                        <div class="navbar-inner">
                            <div class="left"><a href="#" class="open-panel link">☰</a></div>
                            <div class="center" id="main-title">Джейк Трент</div>
                            <div class="right" style="padding-right:15px;"><span id="lv-display">LV 1</span></div>
                        </div>
                    </div>
                    <div class="page-content" id="chat-scroller">
                        <div id="chat-box" style="padding: 10px 8px;"></div>
                        <div id="typing-notice" style="padding: 10px; font-style: italic; opacity: 0.5; display: none;">Детектив размышляет...</div>
                    </div>
                    <div class="toolbar messagebar">
                        <div class="toolbar-inner">
                            <textarea id="msg-input" placeholder="..."></textarea>
                            <a href="#" class="link" onclick="handleSend()"><span class="send-icon">➤</span></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/framework7/1.4.2/js/framework7.min.js"></script>
    <script>
        var myApp = new Framework7({ material: true });
        var state = { char: 'Jake', lv: 1 };
        var chatHistories = { Jake: [], Henri: [] };

        function toggleNight() {
            if (document.getElementById('dark-toggle').checked) document.body.classList.add('layout-dark');
            else document.body.classList.remove('layout-dark');
        }

        function switchChar(id) {
            state.char = id;
            document.getElementById('main-title').innerText = id === 'Jake' ? 'Джейк Трент' : 'Анри Делакруа';
            renderHistory();
        }

        function setLv(n) {
            state.lv = n;
            document.getElementById('lv-display').innerText = 'LV ' + n;
        }

        function draw(text, type) {
            var box = document.getElementById('chat-box');
            var charClass = (state.char === 'Jake') ? 'theme-jake' : 'theme-henri';
            var html = '<div class="message message-' + type + ' ' + charClass + '"><div class="message-text">' + text + '</div></div>';
            box.insertAdjacentHTML('beforeend', html);
            document.getElementById('chat-scroller').scrollTop = 999999;
        }

        function renderHistory() {
            var box = document.getElementById('chat-box');
            box.innerHTML = '';
            var h = chatHistories[state.char];
            if(h.length === 0) {
                draw(state.char === 'Jake' ? "Слушаю. Что за дело?" : "Я к вашим услугам. О чем поговорим?", 'received');
            } else {
                for(var i=0; i<h.length; i++) draw(h[i].text, h[i].type);
            }
        }

        async function handleSend() {
            var inp = document.getElementById('msg-input');
            var text = inp.value.trim();
            if(!text) return;
            chatHistories[state.char].push({text: text, type: 'sent'});
            draw(text, 'sent');
            inp.value = '';
            document.getElementById('typing-notice').style.display = 'block';
            try {
                var res = await fetch('https://logic-q6qn.onrender.com/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({char_id: state.char + state.lv, history: chatHistories[state.char].slice(-8)})
                });
                var data = await res.json();
                document.getElementById('typing-notice').style.display = 'none';
                if(data.reply) {
                    chatHistories[state.char].push({text: data.reply, type: 'received'});
                    draw(data.reply, 'received');
                }
            } catch(e) { 
                document.getElementById('typing-notice').style.display = 'none';
                draw("Ошибка связи.", 'received');
            }
        }
        renderHistory();
    </script>
</body>
</html>

